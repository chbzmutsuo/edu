# 🔌 Socket.io リアルタイム通信の仕組み

## 📚 中学生でもわかる説明

### 🎭 例え話：教室での授業配信システム

想像してみてください。先生が1人、生徒が30人いる教室があります。

#### **普通のウェブサイト（HTTP）の場合：**

```
生徒A: 「先生、今何ページですか？」
  ↓ (質問を送る)
先生: 「3ページです」
  ↓ (返事を送る)
生徒A: （画面が更新される）

（1秒後）
生徒A: 「先生、今何ページですか？」← また質問！
先生: 「4ページです」
```

**問題点：**

- 毎回質問しないと更新されない
- 30人全員が毎秒質問したら先生が大変
- 先生からの「次のページに進んで！」を伝えられない

#### **Socket.io（リアルタイム通信）の場合：**

```
【最初に1回だけ】
生徒A: 「先生、授業の中継をお願いします」
先生: 「わかりました、繋がりました」
  ↓
（無線でずっと繋がった状態）
  ↓
【その後は自動的に】
先生: 「みんな、次のスライドに進んで」→ 自動で全員に届く
先生: 「今から問題に答えてください」→ 自動で全員に届く
生徒A: 「回答を送ります」→ 自動で先生に届く
```

**利点：**

- 一度繋がれば、お互い自由にメッセージを送れる
- 先生から全員に一斉送信できる
- 質問しなくても自動で更新される

---

## 🏗️ Socket.ioの構造

### 1. 全体像

```
┌─────────────────────────────────────────────┐
│         サーバー（Next.js）                  │
│                                             │
│  ┌───────────────────────────────────────┐  │
│  │   Socket.io Server                   │  │
│  │   （無線の中継局みたいなもの）          │  │
│  │                                       │  │
│  │   ┌─────────────────────────────┐   │  │
│  │   │  game-123 の部屋              │   │  │
│  │   │  👨‍🏫 田中先生                  │   │  │
│  │   │  👨‍🎓 山田太郎                  │   │  │
│  │   │  👩‍🎓 佐藤花子                  │   │  │
│  │   │  👨‍🎓 鈴木一郎                  │   │  │
│  │   └─────────────────────────────┘   │  │
│  │                                       │  │
│  │   ┌─────────────────────────────┐   │  │
│  │   │  game-456 の部屋              │   │  │
│  │   │  👩‍🏫 山本先生                  │   │  │
│  │   │  👩‍🎓 高橋美咲                  │   │  │
│  │   └─────────────────────────────┘   │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
               ↕️ (WebSocket接続)
┌─────────────────────────────────────────────┐
│      クライアント（ブラウザ）                 │
│                                             │
│  ┌───────────────────────────────────────┐  │
│  │   useColaboSocket フック              │  │
│  │   （生徒や先生のタブレット）            │  │
│  │                                       │  │
│  │   接続 → メッセージ送受信               │  │
│  └───────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

### 2. 部屋（Room）の仕組み

Socket.ioでは「部屋」という概念があります。

```
game-123 の部屋
├── 👨‍🏫 田中先生 (socket: abc123)
├── 👨‍🎓 山田太郎 (socket: def456)
├── 👩‍🎓 佐藤花子 (socket: ghi789)
└── 👨‍🎓 鈴木一郎 (socket: jkl012)

game-456 の部屋
├── 👩‍🏫 山本先生 (socket: mno345)
└── 👩‍🎓 高橋美咲 (socket: pqr678)
```

**ポイント：**

- 各授業（Game）ごとに部屋が作られる
- 同じ部屋の人だけがメッセージを受け取れる
- 他の部屋のメッセージは届かない

---

## 📨 メッセージの流れ

### ケース1：先生が「次のスライド」ボタンを押した

```
①  田中先生のブラウザ
    ↓ emit('teacher:change-slide', {slideId: 5})

②  サーバー（Socket.io）
    ↓ to('game-123').emit('game:state-sync', {slideId: 5})

③  game-123の全員のブラウザ
    ↓ on('game:state-sync', (data) => {...})

④  各生徒の画面が自動更新
```

### ケース2：生徒が回答を送信

```
①  山田太郎のブラウザ
    ↓ emit('student:submit-answer', {answer: 'A'})

②  サーバー（Socket.io）
    ↓ 本人に確認: emit('student:answer-saved', {success: true})
    ↓ 先生に通知: to(田中先生).emit('game:answer-updated', {...})

③  山田太郎: 「送信完了」画面表示
    田中先生: 「回答数: 1/30」に更新
```

---

## 🔧 接続の手順（技術的な詳細）

### ステップ1: サーバー起動

```typescript
// /pages/api/colabo-socket/index.ts

const io = new SocketIOServer(httpServer, {
  path: '/api/colabo-socket/', // 接続パス
  transports: ['polling', 'websocket'], // 接続方法
})

io.on('connection', socket => {
  console.log('誰かが接続してきた:', socket.id)

  // メッセージを受け取る準備
  socket.on('join-game', data => {
    // 部屋に入れる
    socket.join(`game-${data.gameId}`)
  })
})
```

### ステップ2: クライアント接続

```typescript
// useColaboSocket.tsx

const socket = io('http://localhost:3000', {
  path: '/api/colabo-socket/',
})

// 接続
socket.connect()

// 接続成功
socket.on('connect', () => {
  // 部屋に入る
  socket.emit('join-game', {gameId: 123, role: 'student'})
})
```

### ステップ3: メッセージ送受信

```typescript
// 送信
socket.emit('イベント名', データ)

// 受信
socket.on('イベント名', データ => {
  // 処理
})
```

---

## 🚦 接続の状態遷移

```
disconnected（切断）
    ↓ socket.connect()
connecting（接続中...）
    ↓ 成功
connected（接続済み ✅）
    ↓ emit('join-game')
room joined（部屋に参加 🏠）
    ↓
メッセージ送受信可能 💬
    ↓
    ↓ ネットワーク切断
disconnected（切断）
    ↓ 自動再接続試行
connecting（接続中...）
    ↓ 成功
connected（接続済み ✅）
    ↓ 自動的に再参加
room joined（部屋に参加 🏠）
```

---

## 🐛 よくあるエラーと解決方法

### エラー1: "Invalid namespace"

**原因：** サーバーが正しく起動していない

**解決方法：**

```bash
# サーバーを再起動
npm run dev
```

### エラー2: "WebSocket is closed"

**原因：** 接続パスが間違っている

**解決方法：**

- サーバー側: `path: '/api/colabo-socket/'` （末尾にスラッシュ）
- クライアント側: `path: '/api/colabo-socket/'` （同じにする）

### エラー3: "Connection timeout"

**原因：** サーバーが応答しない

**チェックポイント：**

1. サーバーが起動しているか確認
2. ファイアウォールで3000番ポートが開いているか
3. `http://localhost:3000/api/colabo-socket/` にブラウザでアクセスできるか

---

## 🔍 デバッグ方法

### ブラウザのコンソールで確認

```javascript
// 接続状態
[useColaboSocket] 接続開始...
[useColaboSocket] 接続先: http://localhost:3000
[useColaboSocket] Socket.io接続成功
[useColaboSocket] 接続確認応答: {success: true}

// メッセージ
[useColaboSocket] 状態同期: {slideId: 5}
```

### サーバーログで確認

```bash
[Colabo Socket.io] サーバーが起動しました
[Colabo Socket.io] クライアント接続: abc123
[Colabo Socket.io] student (userId: 1) が Game 123 に参加
```

---

## 🎯 まとめ

### Socket.ioが必要な理由

1. **リアルタイム性：** 先生の操作が即座に全員に反映
2. **双方向通信：** 先生↔生徒の両方向で自由にメッセージ
3. **効率性：** 毎回質問しなくても自動更新
4. **スケール：** 30人でも300人でも対応可能

### 接続の流れ（おさらい）

```
1. クライアント: socket.connect()
   ↓
2. サーバー: 'connection' イベント
   ↓
3. クライアント: emit('join-game')
   ↓
4. サーバー: socket.join('game-123')
   ↓
5. 双方向通信開始！
```

### 今回の修正内容

1. ✅ サーバー側の初期化を改善
2. ✅ クライアント側の接続URLを明示的に指定
3. ✅ エラーハンドリングを強化
4. ✅ デバッグログを追加
5. ✅ 再接続ロジックを改善

これで、安定したリアルタイム通信ができるようになりました！🎉
